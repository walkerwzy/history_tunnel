<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        .modal-enter { animation: modalIn 0.3s ease-out; }
        @keyframes modalIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .drop-zone.dragover { border-color: #3b82f6; background: rgba(59, 130, 246, 0.1); }
        .category-tag {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .two-line-cell {
            overflow: hidden !important;
            display: -webkit-box !important;
            -webkit-line-clamp: 2 !important;
            -webkit-box-orient: vertical !important;
            line-height: 1.3 !important;
        }
        /* Custom select styling */
        .custom-select {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-color: white;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%236b7280'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1rem;
            padding-right: 2.5rem;
        }
        .custom-select::-ms-expand {
            display: none;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-slate-100 min-h-screen">
    <!-- Header -->
    <header class="glass sticky top-0 z-40 border-b border-white/20">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
                <!-- Title -->
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl flex items-center justify-center shadow-lg">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <h1 class="text-2xl font-bold text-slate-800">管理后台</h1>
                </div>

                <!-- Controls -->
                <div class="flex flex-wrap items-center gap-3">
                    <!-- Region Toggle -->
                    <div class="bg-white rounded-lg p-1 shadow-sm border border-slate-200">
                        <div class="flex">
                            <button onclick="setRegion('Chinese')" id="btn-chinese" class="px-4 py-2 rounded-md text-sm font-medium transition-all bg-blue-500 text-white shadow-md">
                                中国
                            </button>
                            <button onclick="setRegion('European')" id="btn-european" class="px-4 py-2 rounded-md text-sm font-medium transition-all text-slate-600 hover:text-slate-900">
                                欧洲
                            </button>
                        </div>
                    </div>

                    <!-- Upload Zone -->
                    <div id="drop-zone" class="drop-zone relative border-2 border-dashed border-slate-300 rounded-lg px-4 py-2 bg-white/50 hover:bg-white/80 transition-all cursor-pointer">
                        <input type="file" id="file-input" accept=".tsv" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="handleFileSelect(event)">
                        <div class="flex items-center gap-2 text-sm text-slate-600">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                            </svg>
                            <span>拖拽或点击上传TSV</span>
                        </div>
                    </div>

                    <!-- Download Template -->
                    <button onclick="downloadTemplate()" class="flex items-center gap-2 px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg text-sm font-medium transition-all">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                        </svg>
                        下载模板
                    </button>

                    <!-- Add Event -->
                    <button onclick="openModal()" class="flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white rounded-lg text-sm font-medium transition-all shadow-md hover:shadow-lg">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                        添加事件
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <!-- Stats & Info -->
        <div id="stats-bar" class="mb-4 flex items-center justify-between text-sm text-slate-600">
            <span id="total-info">加载中...</span>
            <span id="filter-info" class="hidden text-blue-600"></span>
            <span id="page-info"></span>
        </div>

        <!-- Search & Filter Bar -->
        <div class="mb-4 p-4 bg-white rounded-xl shadow-sm border border-slate-200">
            <div class="flex flex-wrap gap-3 items-end">
                <!-- Search Input -->
                <div class="flex-1 min-w-64">
                    <label class="block text-xs font-medium text-slate-600 mb-1">搜索事件名称</label>
                    <div class="relative">
                        <input type="text" id="search-input" placeholder="输入关键词搜索..." 
                            onkeyup="debounceSearch()"
                            class="w-full pl-10 pr-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm">
                        <svg class="w-5 h-5 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                    </div>
                </div>

                <!-- Category Filter -->
                <div class="w-32">
                    <label class="block text-xs font-medium text-slate-600 mb-1">分类筛选</label>
                    <select id="filter-category" onchange="applyFilters()"
                        class="custom-select w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm">
                        <option value="">全部分类</option>
                        <option value="政治">政治</option>
                        <option value="军事">军事</option>
                        <option value="文化">文化</option>
                        <option value="经济">经济</option>
                        <option value="宗教">宗教</option>
                    </select>
                </div>

                <!-- Year Range -->
                <div class="flex gap-2 items-end">
                    <div class="w-24">
                        <label class="block text-xs font-medium text-slate-600 mb-1">起始年份</label>
                        <input type="number" id="filter-year-start" placeholder="不限" 
                            onchange="applyFilters()"
                            class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm">
                    </div>
                    <span class="text-slate-400 pb-2">-</span>
                    <div class="w-24">
                        <label class="block text-xs font-medium text-slate-600 mb-1">结束年份</label>
                        <input type="number" id="filter-year-end" placeholder="不限" 
                            onchange="applyFilters()"
                            class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm">
                    </div>
                </div>

                <!-- Clear Filters -->
                <button onclick="clearFilters()" class="px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-lg text-sm font-medium transition-all">
                    清除筛选
                </button>
            </div>
        </div>

        <!-- Events Table -->
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <!-- Batch Actions Bar -->
            <div id="batch-actions-bar" class="hidden px-4 py-2 bg-blue-50 border-b border-blue-200 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <input type="checkbox" id="select-all" onchange="toggleSelectAll()" class="w-4 h-4 text-blue-600 rounded">
                    <label for="select-all" class="text-sm text-blue-700 cursor-pointer">全选 / 取消全选</label>
                    <span id="selected-count" class="text-sm text-blue-600">已选择 0 项</span>
                </div>
                <button onclick="batchDeleteEvents()" class="px-3 py-1 bg-red-500 hover:bg-red-600 text-white text-sm rounded-lg transition-colors flex items-center gap-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                    批量删除
                </button>
            </div>
            
            <div class="overflow-x-auto">
                <table class="w-full table-fixed">
                    <thead class="bg-slate-50 border-b border-slate-200">
                        <tr>
                            <th class="px-3 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider w-10"></th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider w-1/4">事件名称</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider w-20">开始年份</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider w-20">结束年份</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider w-32">关键人物</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider w-1/4">事件详情</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider w-1/4">事件影响</th>
                            <th class="px-4 py-3 text-center text-xs font-semibold text-slate-600 uppercase tracking-wider w-16">操作</th>
                        </tr>
                    </thead>
                    <tbody id="events-table-body" class="divide-y divide-slate-100">
                        <!-- Events will be inserted here -->
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="px-4 py-3 bg-slate-50 border-t border-slate-200 flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <span class="text-sm text-slate-600">每页显示:</span>
                    <select id="page-size" onchange="changePageSize()" class="custom-select text-sm border border-slate-300 rounded-md px-2 py-1 bg-white">
                        <option value="10">10</option>
                        <option value="25">25</option>
                        <option value="50" selected>50</option>
                        <option value="100">100</option>
                    </select>
                </div>

                <div class="flex items-center gap-1" id="pagination">
                    <!-- Pagination buttons will be inserted here -->
                </div>
            </div>
        </div>

        <!-- Upload Results -->
        <div id="upload-results" class="hidden mt-6 bg-white rounded-xl shadow-sm border border-slate-200 p-4">
            <h3 class="text-lg font-semibold text-slate-800 mb-3">上传结果</h3>
            <div class="grid grid-cols-3 gap-4 mb-4">
                <div class="bg-green-50 border border-green-200 rounded-lg p-3 text-center">
                    <div class="text-2xl font-bold text-green-600" id="success-count">0</div>
                    <div class="text-sm text-green-700">成功导入</div>
                </div>
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 text-center">
                    <div class="text-2xl font-bold text-yellow-600" id="duplicate-count">0</div>
                    <div class="text-sm text-yellow-700">重复跳过</div>
                </div>
                <div class="bg-red-50 border border-red-200 rounded-lg p-3 text-center">
                    <div class="text-2xl font-bold text-red-600" id="failed-count">0</div>
                    <div class="text-sm text-red-700">导入失败</div>
                </div>
            </div>
            <div id="failed-rows-container" class="hidden">
                <h4 class="text-sm font-semibold text-red-700 mb-2">失败详情:</h4>
                <div id="failed-rows-list" class="text-sm text-red-600 max-h-40 overflow-y-auto bg-red-50 rounded-lg p-3"></div>
            </div>
        </div>
    </main>

    <!-- Event Modal -->
    <div id="event-modal" class="hidden fixed inset-0 z-50 overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <!-- Backdrop -->
            <div class="fixed inset-0 bg-slate-900/50 transition-opacity" onclick="closeModal()"></div>

            <!-- Modal Panel -->
            <div class="modal-enter inline-block align-bottom bg-white rounded-2xl text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-2xl sm:w-full">
                <div class="bg-gradient-to-r from-blue-500 to-indigo-600 px-6 py-4">
                    <h3 class="text-lg font-semibold text-white" id="modal-title">添加事件</h3>
                </div>

                <form id="event-form" class="px-6 py-4 space-y-4 max-h-[70vh] overflow-y-auto">
                    <input type="hidden" id="event-id">

                    <!-- 第一行：事件名称（3/4）+ 地区（1/4） -->
                    <div class="grid grid-cols-4 gap-4">
                        <div class="col-span-3">
                            <label class="block text-sm font-medium text-slate-700 mb-1"><span class="text-red-500">*</span> 事件名称</label>
                            <input type="text" id="event_name" required class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">地区</label>
                            <div class="flex gap-3 py-2">
                                <label class="flex items-center">
                                    <input type="radio" name="region" value="Chinese" checked class="w-4 h-4 text-blue-600">
                                    <span class="ml-1 text-sm text-slate-700">中国</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="region" value="European" class="w-4 h-4 text-blue-600">
                                    <span class="ml-1 text-sm text-slate-700">欧洲</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-4 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1"><span class="text-red-500">*</span> 开始年份</label>
                            <input type="number" id="start_year" required class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">结束年份</label>
                            <input type="number" id="end_year" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">重要程度</label>
                            <input type="number" id="importance_level" min="1" max="10" value="5" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">分类</label>
                            <select id="category" class="custom-select w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="">请选择</option>
                                <option value="政治">政治</option>
                                <option value="军事">军事</option>
                                <option value="文化">文化</option>
                                <option value="经济">经济</option>
                                <option value="宗教">宗教</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">关键人物</label>
                        <input type="text" id="key_figures" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">事件描述</label>
                        <textarea id="description" rows="3" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">事件影响</label>
                        <textarea id="impact" rows="3" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">来源</label>
                        <input type="url" id="source" placeholder="https://..." class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </form>

                <div class="px-6 py-4 bg-slate-50 flex justify-end gap-3">
                    <button type="button" onclick="closeModal()" class="px-4 py-2 text-sm font-medium text-slate-700 hover:text-slate-900 transition-colors">
                        取消
                    </button>
                    <button type="button" onclick="saveEvent()" class="px-4 py-2 bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white text-sm font-medium rounded-lg shadow-md transition-all">
                        保存
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="hidden fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg transform transition-all duration-300 z-50">
        <span id="toast-message"></span>
    </div>

    <script>
        // State
        let currentRegion = 'Chinese';
        let currentPage = 0;
        let pageSize = 50;
        let totalEvents = 0;
        let events = [];
        let filteredEvents = [];
        let searchTimeout = null;

        // Category colors - consistent across all pages
        const categoryColors = {
            '政治': 'bg-red-100 text-red-700 border-red-200',
            '军事': 'bg-orange-100 text-orange-700 border-orange-200',
            '文化': 'bg-purple-100 text-purple-700 border-purple-200',
            '经济': 'bg-green-100 text-green-700 border-green-200',
            '宗教': 'bg-indigo-100 text-indigo-700 border-indigo-200',
            'default': 'bg-slate-100 text-slate-700 border-slate-200'
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadEvents();
            setupDragAndDrop();
        });

        // Set region
        function setRegion(region) {
            currentRegion = region;
            currentPage = 0;
            
            // Clear filters when changing region
            clearFilters();

            // Update button styles
            document.getElementById('btn-chinese').className = region === 'Chinese'
                ? 'px-4 py-2 rounded-md text-sm font-medium transition-all bg-blue-500 text-white shadow-md'
                : 'px-4 py-2 rounded-md text-sm font-medium transition-all text-slate-600 hover:text-slate-900';
            document.getElementById('btn-european').className = region === 'European'
                ? 'px-4 py-2 rounded-md text-sm font-medium transition-all bg-blue-500 text-white shadow-md'
                : 'px-4 py-2 rounded-md text-sm font-medium transition-all text-slate-600 hover:text-slate-900';

            loadEvents();
        }

        // Load events - fetch ALL events for client-side filtering and pagination
        async function loadEvents() {
            try {
                // Fetch all events (no pagination) for client-side processing
                const response = await fetch(`/admin/api/events?region=${currentRegion}&offset=0&limit=1000`);
                console.log('Load events response:', response);

                if (!response.ok) throw new Error('Failed to load events');

                const data = await response.json();
                console.log('Events data:', data);

                // Store all events
                events = data.events || [];
                totalEvents = data.metadata?.total || 0;
                filteredEvents = events;

                // Reset to first page
                currentPage = 0;

                renderFilteredEvents();
            } catch (error) {
                console.error('Error loading events:', error);
                showToast('加载事件失败', 'error');
            }
        }

        // Render events table (deprecated - use renderFilteredEvents)
        function renderPagination() {
            const totalPages = Math.ceil(totalEvents / pageSize);
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';

            if (totalPages <= 1) return;

            // Previous button
            const prevBtn = document.createElement('button');
            prevBtn.innerHTML = '←';
            prevBtn.className = `px-3 py-1 rounded-md text-sm font-medium ${currentPage === 0 ? 'text-slate-400 cursor-not-allowed' : 'text-slate-600 hover:bg-slate-200'}`;
            prevBtn.onclick = () => { if (currentPage > 0) { currentPage--; loadEvents(); }};
            pagination.appendChild(prevBtn);

            // Page numbers
            const maxVisible = 5;
            let startPage = Math.max(0, currentPage - 2);
            let endPage = Math.min(totalPages - 1, startPage + maxVisible - 1);

            if (endPage - startPage < maxVisible - 1) {
                startPage = Math.max(0, endPage - maxVisible + 1);
            }

            if (startPage > 0) {
                pagination.appendChild(createPageButton(0));
                if (startPage > 1) {
                    const ellipsis = document.createElement('span');
                    ellipsis.textContent = '...';
                    ellipsis.className = 'px-2 text-slate-400';
                    pagination.appendChild(ellipsis);
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                pagination.appendChild(createPageButton(i));
            }

            if (endPage < totalPages - 1) {
                if (endPage < totalPages - 2) {
                    const ellipsis = document.createElement('span');
                    ellipsis.textContent = '...';
                    ellipsis.className = 'px-2 text-slate-400';
                    pagination.appendChild(ellipsis);
                }
                pagination.appendChild(createPageButton(totalPages - 1));
            }

            // Next button
            const nextBtn = document.createElement('button');
            nextBtn.innerHTML = '→';
            nextBtn.className = `px-3 py-1 rounded-md text-sm font-medium ${currentPage >= totalPages - 1 ? 'text-slate-400 cursor-not-allowed' : 'text-slate-600 hover:bg-slate-200'}`;
            nextBtn.onclick = () => { if (currentPage < totalPages - 1) { currentPage++; loadEvents(); }};
            pagination.appendChild(nextBtn);
        }

        function createPageButton(page) {
            const btn = document.createElement('button');
            btn.textContent = page + 1;
            btn.className = `px-3 py-1 rounded-md text-sm font-medium ${page === currentPage ? 'bg-blue-500 text-white' : 'text-slate-600 hover:bg-slate-200'}`;
            btn.onclick = () => { currentPage = page; loadEvents(); };
            return btn;
        }

        // Update stats
        function updateStats() {
            const start = currentPage * pageSize + 1;
            const end = Math.min((currentPage + 1) * pageSize, filteredEvents.length);
            const hasFilters = hasActiveFilters();
            
            if (hasFilters && filteredEvents.length !== totalEvents) {
                document.getElementById('total-info').textContent = `共 ${totalEvents} 条事件`;
                document.getElementById('filter-info').classList.remove('hidden');
                document.getElementById('filter-info').textContent = `筛选后: ${filteredEvents.length} 条`;
                document.getElementById('page-info').textContent = `显示 ${start}-${end} 条`;
            } else {
                document.getElementById('total-info').textContent = `共 ${totalEvents} 条事件`;
                document.getElementById('filter-info').classList.add('hidden');
                document.getElementById('page-info').textContent = `显示 ${start}-${end} 条`;
            }
        }

        // Check if any filters are active
        function hasActiveFilters() {
            const searchValue = document.getElementById('search-input').value.trim();
            const categoryValue = document.getElementById('filter-category').value;
            const yearStart = document.getElementById('filter-year-start').value;
            const yearEnd = document.getElementById('filter-year-end').value;
            return searchValue || categoryValue || yearStart || yearEnd;
        }

        // Debounced search
        function debounceSearch() {
            if (searchTimeout) clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                applyFilters();
            }, 300);
        }

        // Apply all filters
        function applyFilters() {
            const searchValue = document.getElementById('search-input').value.toLowerCase().trim();
            const categoryValue = document.getElementById('filter-category').value;
            const yearStart = parseInt(document.getElementById('filter-year-start').value) || null;
            const yearEnd = parseInt(document.getElementById('filter-year-end').value) || null;

            filteredEvents = events.filter(event => {
                // Search filter - check multiple fields
                if (searchValue) {
                    const searchLower = searchValue.toLowerCase();
                    const nameMatch = event.event_name && event.event_name.toLowerCase().includes(searchLower);
                    const figureMatch = event.key_figures && event.key_figures.toLowerCase().includes(searchLower);
                    const descMatch = event.description && event.description.toLowerCase().includes(searchLower);
                    const impactMatch = event.impact && event.impact.toLowerCase().includes(searchLower);
                    if (!nameMatch && !figureMatch && !descMatch && !impactMatch) {
                        return false;
                    }
                }
                
                // Category filter
                if (categoryValue && event.category !== categoryValue) {
                    return false;
                }
                
                // Year range filter - check if start_year falls within range
                if (yearStart !== null && event.start_year < yearStart) {
                    return false;
                }
                if (yearEnd !== null && event.start_year > yearEnd) {
                    return false;
                }
                
                return true;
            });

            currentPage = 0;
            renderFilteredEvents();
        }

        // Render filtered events
        function renderFilteredEvents() {
            const tbody = document.getElementById('events-table-body');
            tbody.innerHTML = '';

            if (filteredEvents.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="px-4 py-8 text-center text-slate-500">暂无匹配数据</td></tr>';
                document.getElementById('pagination').innerHTML = '';
                document.getElementById('filter-info').classList.remove('hidden');
                document.getElementById('filter-info').textContent = `筛选后: 0 条`;
                return;
            }

            const start = currentPage * pageSize;
            const end = start + pageSize;
            const pageEvents = filteredEvents.slice(start, end);

            pageEvents.forEach(event => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-slate-50 transition-colors cursor-pointer';
                row.onclick = (e) => {
                    // Don't trigger edit if clicking on checkbox or delete button
                    if (e.target.closest('.event-checkbox') || e.target.closest('button')) return;
                    editEvent(event.id);
                };

                row.innerHTML = `
                    <td class="px-3 py-3 text-center" onclick="event.stopPropagation()">
                        <input type="checkbox" class="event-checkbox w-4 h-4 text-blue-600 rounded" data-id="${event.id}">
                    </td>
                    <td class="px-4 py-3 text-sm font-medium text-slate-900">${escapeHtml(event.event_name)}</td>
                    <td class="px-4 py-3 text-sm text-slate-600">${event.start_year}</td>
                    <td class="px-4 py-3 text-sm text-slate-600">${event.end_year || '-'}</td>
                    <td class="px-4 py-3 text-sm text-slate-600 max-w-xs truncate">${escapeHtml(event.key_figures || '-')}</td>
                    <td class="px-4 py-2 max-w-xs"><div class="text-xs text-slate-500 two-line-cell">${escapeHtml(event.description || '-')}</div></td>
                    <td class="px-4 py-2 max-w-xs"><div class="text-xs text-slate-500 two-line-cell">${escapeHtml(event.impact || '-')}</div></td>
                    <td class="px-4 py-3 text-center" onclick="event.stopPropagation()">
                        <button onclick="deleteEvent(${event.id}, event)" class="p-1 text-red-600 hover:bg-red-50 rounded transition-colors">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                    </td>
                `;
                
                // Add checkbox change listener
                const checkbox = row.querySelector('.event-checkbox');
                checkbox.addEventListener('change', updateBatchActionsBar);
                
                tbody.appendChild(row);
            });

            renderFilteredPagination();
            updateStats();
        }

        // Update batch actions bar visibility and count
        function updateBatchActionsBar() {
            const checkboxes = document.querySelectorAll('.event-checkbox:checked');
            const count = checkboxes.length;
            const batchBar = document.getElementById('batch-actions-bar');
            const selectedCount = document.getElementById('selected-count');
            
            if (count > 0) {
                batchBar.classList.remove('hidden');
                selectedCount.textContent = `已选择 ${count} 项`;
            } else {
                batchBar.classList.add('hidden');
            }
        }

        // Toggle select all checkboxes
        function toggleSelectAll() {
            const selectAll = document.getElementById('select-all');
            const checkboxes = document.querySelectorAll('.event-checkbox');
            checkboxes.forEach(cb => cb.checked = selectAll.checked);
            updateBatchActionsBar();
        }

        // Batch delete selected events
        async function batchDeleteEvents() {
            const checkboxes = document.querySelectorAll('.event-checkbox:checked');
            const ids = Array.from(checkboxes).map(cb => parseInt(cb.dataset.id));
            
            if (ids.length === 0) {
                showToast('请先选择要删除的事件', 'error');
                return;
            }
            
            if (!confirm(`确定要删除选中的 ${ids.length} 个事件吗？此操作不可恢复。`)) {
                return;
            }
            
            try {
                let successCount = 0;
                let failedCount = 0;
                
                for (const id of ids) {
                    const response = await fetch(`/admin/api/events/${id}`, { method: 'DELETE' });
                    if (response.ok) {
                        successCount++;
                    } else {
                        failedCount++;
                    }
                }
                
                showToast(`删除完成: ${successCount} 成功, ${failedCount} 失败`, successCount > 0 ? 'success' : 'error');
                
                // Reload events
                clearFilters();
            } catch (error) {
                console.error('Batch delete error:', error);
                showToast('批量删除失败', 'error');
            }
        }

        // Render pagination for filtered results
        function renderFilteredPagination() {
            const totalPages = Math.ceil(filteredEvents.length / pageSize);
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';

            if (totalPages <= 1) return;

            const prevBtn = document.createElement('button');
            prevBtn.innerHTML = '←';
            prevBtn.className = `px-3 py-1 rounded-md text-sm font-medium ${currentPage === 0 ? 'text-slate-400 cursor-not-allowed' : 'text-slate-600 hover:bg-slate-200'}`;
            prevBtn.onclick = () => { if (currentPage > 0) { currentPage--; renderFilteredEvents(); }};
            pagination.appendChild(prevBtn);

            const maxVisible = 5;
            let startPage = Math.max(0, currentPage - 2);
            let endPage = Math.min(totalPages - 1, startPage + maxVisible - 1);

            if (endPage - startPage < maxVisible - 1) {
                startPage = Math.max(0, endPage - maxVisible + 1);
            }

            if (startPage > 0) {
                pagination.appendChild(createFilteredPageButton(0));
                if (startPage > 1) {
                    const ellipsis = document.createElement('span');
                    ellipsis.textContent = '...';
                    ellipsis.className = 'px-2 text-slate-400';
                    pagination.appendChild(ellipsis);
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                pagination.appendChild(createFilteredPageButton(i));
            }

            if (endPage < totalPages - 1) {
                if (endPage < totalPages - 2) {
                    const ellipsis = document.createElement('span');
                    ellipsis.textContent = '...';
                    ellipsis.className = 'px-2 text-slate-400';
                    pagination.appendChild(ellipsis);
                }
                pagination.appendChild(createFilteredPageButton(totalPages - 1));
            }

            const nextBtn = document.createElement('button');
            nextBtn.innerHTML = '→';
            nextBtn.className = `px-3 py-1 rounded-md text-sm font-medium ${currentPage >= totalPages - 1 ? 'text-slate-400 cursor-not-allowed' : 'text-slate-600 hover:bg-slate-200'}`;
            nextBtn.onclick = () => { if (currentPage < totalPages - 1) { currentPage++; renderFilteredEvents(); }};
            pagination.appendChild(nextBtn);
        }

        function createFilteredPageButton(page) {
            const btn = document.createElement('button');
            btn.textContent = page + 1;
            btn.className = `px-3 py-1 rounded-md text-sm font-medium ${page === currentPage ? 'bg-blue-500 text-white' : 'text-slate-600 hover:bg-slate-200'}`;
            btn.onclick = () => { currentPage = page; renderFilteredEvents(); };
            return btn;
        }

        // Clear all filters
        function clearFilters() {
            document.getElementById('search-input').value = '';
            document.getElementById('filter-category').value = '';
            document.getElementById('filter-year-start').value = '';
            document.getElementById('filter-year-end').value = '';
            
            filteredEvents = events;
            currentPage = 0;
            renderFilteredEvents();
        }

        // Change page size
        function changePageSize() {
            pageSize = parseInt(document.getElementById('page-size').value);
            currentPage = 0;
            if (hasActiveFilters()) {
                renderFilteredEvents();
            } else {
                loadEvents();
            }
        }

        // Modal functions
        function openModal(eventId = null) {
            document.getElementById('event-modal').classList.remove('hidden');
            document.getElementById('event-form').reset();
            document.getElementById('event-id').value = '';

            if (eventId) {
                const event = events.find(e => e.id === eventId);
                if (event) {
                    document.getElementById('modal-title').textContent = '编辑事件';
                    document.getElementById('event-id').value = event.id;
                    document.getElementById('event_name').value = event.event_name;
                    document.getElementById('start_year').value = event.start_year;
                    document.getElementById('end_year').value = event.end_year || '';
                    document.getElementById('key_figures').value = event.key_figures || '';
                    document.getElementById('description').value = event.description || '';
                    document.getElementById('impact').value = event.impact || '';
                    document.getElementById('category').value = event.category || '';
                    document.getElementById('importance_level').value = event.importance_level || 5;
                    document.getElementById('source').value = event.source || '';

                    // Set region radio
                    const regionRadio = document.querySelector(`input[name="region"][value="${event.region}"]`);
                    if (regionRadio) regionRadio.checked = true;
                }
            } else {
                document.getElementById('modal-title').textContent = '添加事件';
                // Set default region
                const regionRadio = document.querySelector(`input[name="region"][value="${currentRegion}"]`);
                if (regionRadio) regionRadio.checked = true;
            }
        }

        function closeModal() {
            document.getElementById('event-modal').classList.add('hidden');
        }

        function editEvent(eventId) {
            openModal(eventId);
        }

        // Save event
        async function saveEvent() {
            const eventId = document.getElementById('event-id').value;
            const eventData = {
                event_name: document.getElementById('event_name').value,
                start_year: parseInt(document.getElementById('start_year').value),
                end_year: document.getElementById('end_year').value ? parseInt(document.getElementById('end_year').value) : null,
                key_figures: document.getElementById('key_figures').value,
                description: document.getElementById('description').value,
                impact: document.getElementById('impact').value,
                category: document.getElementById('category').value,
                region: document.querySelector('input[name="region"]:checked').value,
                importance_level: parseInt(document.getElementById('importance_level').value),
                source: document.getElementById('source').value
            };

            try {
                const url = eventId ? `/admin/api/events/${eventId}` : '/admin/api/events';
                const method = eventId ? 'PUT' : 'POST';

                console.log('Saving event:', method, url, eventData);

                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(eventData)
                });

                console.log('Save response:', response);

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || '保存失败');
                }

                const result = await response.json();
                console.log('Save result:', result);

                closeModal();
                showToast(eventId ? '事件已更新' : '事件已创建', 'success');
                loadEvents();
            } catch (error) {
                console.error('Error saving event:', error);
                showToast(error.message, 'error');
            }
        }

        // Delete event
        async function deleteEvent(eventId, event) {
            event.stopPropagation();
            if (!confirm('确定要删除这个事件吗？')) return;

            try {
                const response = await fetch(`/admin/api/events/${eventId}`, { method: 'DELETE' });
                console.log('Delete response:', response);

                if (!response.ok) throw new Error('删除失败');

                showToast('事件已删除', 'success');
                
                // Reload to refresh data
                loadEvents();
            } catch (error) {
                console.error('Error deleting event:', error);
                showToast('删除失败', 'error');
            }
        }

        // Download template
        function downloadTemplate() {
            window.location.href = '/admin/api/template';
        }

        // Drag and drop setup
        function setupDragAndDrop() {
            const dropZone = document.getElementById('drop-zone');

            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });

            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('dragover');
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    uploadFile(files[0]);
                }
            });
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) uploadFile(file);
        }

        // Upload file
        async function uploadFile(file) {
            if (!file.name.endsWith('.tsv')) {
                showToast('请上传TSV文件', 'error');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            try {
                showToast('正在上传...', 'info');
                const response = await fetch('/admin/api/events/batch', {
                    method: 'POST',
                    body: formData
                });

                console.log('Upload response:', response);

                if (!response.ok) throw new Error('上传失败');

                const result = await response.json();
                console.log('Upload result:', result);

                // Show results
                document.getElementById('upload-results').classList.remove('hidden');
                document.getElementById('success-count').textContent = result.success_count;
                document.getElementById('duplicate-count').textContent = result.duplicate_count;
                document.getElementById('failed-count').textContent = result.failed_count;

                const failedContainer = document.getElementById('failed-rows-container');
                const failedList = document.getElementById('failed-rows-list');

                if (result.failed_rows && result.failed_rows.length > 0) {
                    failedContainer.classList.remove('hidden');
                    failedList.innerHTML = result.failed_rows.map(r =>
                        `<div>第 ${r.row} 行: ${r.error}${r.event_name ? ` (${r.event_name})` : ''}</div>`
                    ).join('');
                } else {
                    failedContainer.classList.add('hidden');
                }

                if (result.duplicate_rows && result.duplicate_rows.length > 0) {
                    console.log('Duplicate rows:', result.duplicate_rows);
                }

                showToast(`上传完成: ${result.success_count} 成功, ${result.duplicate_count} 重复, ${result.failed_count} 失败`, 'success');

                if (result.success_count > 0) {
                    loadEvents();
                }
            } catch (error) {
                console.error('Error uploading file:', error);
                showToast('上传失败: ' + error.message, 'error');
            }
        }

        // Toast notification
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');

            toast.className = 'fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg transform transition-all duration-300 z-50';

            if (type === 'success') {
                toast.classList.add('bg-green-500', 'text-white');
            } else if (type === 'error') {
                toast.classList.add('bg-red-500', 'text-white');
            } else {
                toast.classList.add('bg-blue-500', 'text-white');
            }

            toastMessage.textContent = message;
            toast.classList.remove('hidden');

            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        // Escape HTML
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Close modal on escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeModal();
        });
    </script>
</body>
</html>
